<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parallel workflows with Snakemake &mdash; HPDA-Python  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx_lesson.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx_rtd_theme_ext_color_contrast.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/overrides.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script src="../_static/tabs.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script data-domain="enccs.github.io/hpda-python" defer="defer" src="https://plausible.io/js/script.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            HPDA-Python
              <img src="../_static/ENCCS.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Preparation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/">Installation and HPC access</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">The lesson</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../motivation/">Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scientific-data/">Scientific data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stack/">Efficient array computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel-computing/">Parallel computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimization/">Profiling and optimising</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance-boosting/">Performance boosting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dask/">Dask for scalable analytics</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Optional material</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pandas-extra/">Optional: more on Pandas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GPU-computing/">GPU computing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guide/">Instructor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">HPDA-Python</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Parallel workflows with Snakemake</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ENCCS/HPDA-Python/blob/main/content/parallel-computing_opt.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="parallel-workflows-with-snakemake">
<h1>Parallel workflows with Snakemake<a class="headerlink" href="#parallel-workflows-with-snakemake" title="Permalink to this heading"></a></h1>
<p>Many scientific problems involve complicated workflows with multiple interdependent steps.
If the workflow involves performing the same analysis on many different datasets we can
use the inherent (“embarrassing”) parallelism of the problem and perform these simultaneously.</p>
<p>Let us have a look at a toy example which many of us can hopefully relate to.</p>
<div class="admonition-demo-the-word-count-project demo admonition" id="demo-0">
<p class="admonition-title">Demo: The word-count project</p>
<p>Head over to <a class="reference external" href="https://github.com/enccs/word-count-hpda">https://github.com/enccs/word-count-hpda</a> and clone the repository:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/ENCCS/word-count-hpda.git
</pre></div>
</div>
<p>This project is about counting words in a given text and print out the 10 most common
words which can be used to test <a class="reference external" href="https://en.wikipedia.org/wiki/Zipf%27s_law">Zipf’s law</a>.
The <code class="docutils literal notranslate"><span class="pre">data</span></code> directory contains 64 public domain books from <a class="reference external" href="https://www.gutenberg.org/">Project Gutenberg</a>
and source files under <code class="docutils literal notranslate"><span class="pre">source</span></code> can be used to count words:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="c1"># count words in two books</span>
<span class="gp">$ </span>python<span class="w"> </span>source/wordcount.py<span class="w"> </span>data/pg10.txt<span class="w"> </span>processed_data/pg10.dat
<span class="gp">$ </span>python<span class="w"> </span>source/wordcount.py<span class="w"> </span>data/pg65.txt<span class="w"> </span>processed_data/pg65.dat

<span class="gp">$ </span><span class="c1"># print frequency of 10 most frequent words in both books to file</span>
<span class="gp">$ </span>python<span class="w"> </span>source/zipf_test.py<span class="w"> </span><span class="m">10</span><span class="w"> </span>processed_data/pg10.dat<span class="w"> </span>processed_data/pg65.dat<span class="w"> </span>&gt;<span class="w"> </span>results/results.csv
</pre></div>
</div>
<p>This workflow is encoded in the <code class="docutils literal notranslate"><span class="pre">Snakefile</span></code> which can be used to run
through all data files:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="c1"># run workflow in serial</span>
<span class="gp">$ </span>snakemake<span class="w"> </span>-j<span class="w"> </span><span class="m">1</span>
</pre></div>
</div>
<p>The workflow can be visualised in a directed-acyclic graph:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="c1"># requires dot from Graphviz</span>
<span class="gp">$ </span>snakemake<span class="w"> </span>-j<span class="w"> </span><span class="m">1</span><span class="w"> </span>--dag<span class="w"> </span><span class="p">|</span><span class="w"> </span>dot<span class="w"> </span>-Tpng<span class="w">  </span>&gt;<span class="w"> </span>dag.png
</pre></div>
</div>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/dag.png"><img alt="../_images/dag.png" src="../_images/dag.png" style="width: 474.40000000000003px; height: 200.8px;" /></a>
</figure>
<p>The workflow can be parallelized to utilize multiple cores:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">  $ </span><span class="c1"># first clear all output</span>
<span class="gp">  $ </span>snakemake<span class="w"> </span>-j<span class="w"> </span><span class="m">1</span><span class="w"> </span>--delete-all-output
<span class="gp">  $ </span><span class="c1"># run in parallel on 4 processes</span>
<span class="gp">  $ </span>snakemake<span class="w"> </span>-j<span class="w"> </span><span class="m">4</span>

<span class="go">For embarrassingly parallel work one can achieve significant speedup with parallel Snakemake execution.</span>
</pre></div>
</div>
</div>
<p>The Snakefile describes the workflow in declarative style, i.e. we describe
the dependencies but let Snakemake figure out the series of steps to produce
results (targets). This is how the Snakefile looks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># a list of all the books we are analyzing</span>
<span class="n">DATA</span> <span class="o">=</span> <span class="n">glob_wildcards</span><span class="p">(</span><span class="s1">&#39;data/</span><span class="si">{book}</span><span class="s1">.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">book</span>

<span class="c1"># the default rule</span>
<span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="s1">&#39;results/results.csv&#39;</span>

<span class="c1"># count words in one of our books</span>
<span class="c1"># logfiles from each run are put in .log files&quot;</span>
<span class="n">rule</span> <span class="n">count_words</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="n">wc</span><span class="o">=</span><span class="s1">&#39;source/wordcount.py&#39;</span><span class="p">,</span>
        <span class="n">book</span><span class="o">=</span><span class="s1">&#39;data/</span><span class="si">{file}</span><span class="s1">.txt&#39;</span>
    <span class="n">output</span><span class="p">:</span> <span class="s1">&#39;processed_data/</span><span class="si">{file}</span><span class="s1">.dat&#39;</span>
    <span class="n">log</span><span class="p">:</span> <span class="s1">&#39;processed_data/</span><span class="si">{file}</span><span class="s1">.log&#39;</span>
    <span class="n">shell</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            python {input.wc} {input.book} {output} &gt;&gt; {log} 2&gt;&amp;1</span>
<span class="sd">        &#39;&#39;&#39;</span>

<span class="c1"># generate results table</span>
<span class="n">rule</span> <span class="n">zipf_test</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="n">zipf</span><span class="o">=</span><span class="s1">&#39;source/zipf_test.py&#39;</span><span class="p">,</span>
        <span class="n">books</span><span class="o">=</span><span class="n">expand</span><span class="p">(</span><span class="s1">&#39;processed_data/</span><span class="si">{book}</span><span class="s1">.dat&#39;</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="n">DATA</span><span class="p">)</span>
    <span class="n">params</span><span class="p">:</span>
        <span class="n">nwords</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">output</span><span class="p">:</span> <span class="s1">&#39;results/results.csv&#39;</span>
    <span class="n">shell</span><span class="p">:</span>  <span class="s1">&#39;python </span><span class="si">{input.zipf}</span><span class="s1"> </span><span class="si">{params.nwords}</span><span class="s1"> </span><span class="si">{input.books}</span><span class="s1"> &gt; </span><span class="si">{output}</span><span class="s1">&#39;</span>
</pre></div>
</div>
</section>
<section id="ipyparallel">
<h1>ipyparallel<a class="headerlink" href="#ipyparallel" title="Permalink to this heading"></a></h1>
<p><a class="reference external" href="https://ipyparallel.readthedocs.io/en/latest/">ipyparallel</a>, also known as IPython Parallel,
is yet another tool for parallel computing in Python. However, it’s more than just parallel Python,
it’s parallel <em>IPython</em>, and this adds interactivity to parallel computing.</p>
<p>The architecture of ipyparallel for parallel and distributed computing abstracts out parallelism in a
general way and this enables many different styles of parallelism, including:</p>
<ul class="simple">
<li><p>Single program, multiple data (SPMD) parallelism</p></li>
<li><p>Multiple program, multiple data (MPMD) parallelism</p></li>
<li><p>Message passing using MPI</p></li>
<li><p>Task farming</p></li>
<li><p>Data parallel</p></li>
<li><p>Combinations of these approaches</p></li>
<li><p>Custom user-defined approaches</p></li>
</ul>
<p>This is similar to Dask which will be covered in a later episode.</p>
<p>Let’s explore how ipyparallel can be used together with MPI.
The following code will initialize an IPython Cluster with 8 MPI engines in one of two ways:</p>
<ul class="simple">
<li><p>Inside a context manager to automatically manage starting and stopping engines.</p></li>
<li><p>In a terminal and connect to it from a Jupyter notebook.</p></li>
</ul>
<p>After initializing the cluster, we create a “broadcast view” to the engines, and finally
use the <code class="xref py py-meth docutils literal notranslate"><span class="pre">apply_sync()</span></code> function to run the <code class="xref py py-meth docutils literal notranslate"><span class="pre">mpi_example()</span></code> function on the engines:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">Context manager</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">In terminal with <code class="docutils literal notranslate"><span class="pre">ipcluster</span></code></button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p>Define function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mpi_example</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
    <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Hello World from rank </span><span class="si">{</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span><span class="si">}</span><span class="s2">. Total ranks=</span><span class="si">{</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Start cluster in context manager:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ipyparallel</span> <span class="k">as</span> <span class="nn">ipp</span>
<span class="c1"># request an MPI cluster with 4 engines</span>
<span class="k">with</span> <span class="n">ipp</span><span class="o">.</span><span class="n">Cluster</span><span class="p">(</span><span class="n">engines</span><span class="o">=</span><span class="s1">&#39;mpi&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">cluster</span><span class="p">:</span>
   <span class="c1"># get a broadcast_view on the cluster which is best suited for MPI style computation</span>
   <span class="n">view</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">broadcast_view</span><span class="p">()</span>
   <span class="c1"># run the mpi_example function on all engines in parallel</span>
   <span class="n">r</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">apply_sync</span><span class="p">(</span><span class="n">mpi_example</span><span class="p">)</span>

<span class="c1"># Retrieve and print the result from the engines</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p>Define function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mpi_example</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
    <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Hello World from rank </span><span class="si">{</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span><span class="si">}</span><span class="s2">. Total ranks=</span><span class="si">{</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Start engines in terminal:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="c1"># load module with MPI</span>
<span class="gp">$ </span>ml<span class="w"> </span>add<span class="w"> </span>foss/2021b
<span class="gp">$ </span>ipcluster<span class="w"> </span>start<span class="w"> </span>-n<span class="w"> </span><span class="m">8</span><span class="w"> </span>--engines<span class="o">=</span>MPI
</pre></div>
</div>
<p>Connect from a code cell in Jupyter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ipyparallel</span> <span class="k">as</span> <span class="nn">ipp</span>
<span class="n">cluster</span> <span class="o">=</span> <span class="n">ipp</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
<span class="c1"># print engine indices</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
<span class="n">view</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">broadcast_view</span><span class="p">()</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">apply_sync</span><span class="p">(</span><span class="n">mpi_example</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
</pre></div>
</div>
</div></div>
<p>In an exercise below you can practice using ipyparallel for running an interactive MPI job in Jupyter
for the word-count project.</p>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, ENCCS and individual contributors..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>